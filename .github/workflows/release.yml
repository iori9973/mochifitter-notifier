name: Release and Update VPM Listing

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  # ---------------------------------------------------------------
  # Job 0: テスト（失敗時はリリースをブロック）
  # ---------------------------------------------------------------
  test:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore
        run: dotnet restore Tests/MochiFitterNotifier.Tests.csproj

      - name: Build（型チェック・静的解析）
        run: dotnet build Tests/MochiFitterNotifier.Tests.csproj --no-restore --configuration Release

      - name: Test
        run: dotnet test Tests/MochiFitterNotifier.Tests.csproj --no-build --configuration Release --logger "console;verbosity=normal"

  # ---------------------------------------------------------------
  # Job 1: zip 作成 → GitHub Release 作成
  # ---------------------------------------------------------------
  release:
    needs: test
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Create VPM Zip
        run: |
          zip -r "mochifitter-notifier-${{ steps.version.outputs.version }}.zip" . \
            --exclude "*.git*" \
            --exclude "sample/*" \
            --exclude ".github/*" \
            --exclude "docs/*"

      - name: Create BOOTH zip
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          sed "s/\${VERSION}/${VERSION}/g" .github/scripts/booth-readme.txt > README.txt
          printf '[InternetShortcut]\nURL=https://iori9973.github.io/mochifitter-notifier/\n' > "VCCへの追加.url"
          zip "MochiFitterBell-${VERSION}-booth.zip" \
            README.txt \
            "VCCへの追加.url"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            mochifitter-notifier-${{ steps.version.outputs.version }}.zip
            MochiFitterBell-${{ steps.version.outputs.version }}-booth.zip
          generate_release_notes: true
          tag_name: ${{ github.ref_name }}

  # ---------------------------------------------------------------
  # Job 2: VPM listing 更新（main を明示 checkout してから push）
  # ---------------------------------------------------------------
  update-listing:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Switch to main and pull latest
        run: |
          git checkout main
          git pull origin main

      - name: Build VPM listing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_VERSION: ${{ needs.release.outputs.version }}
        run: python3 .github/scripts/build_listing.py

      - name: Commit updated listing
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/index.json
          git diff --staged --quiet || git commit -m "Update VPM listing for v${{ needs.release.outputs.version }} [skip ci]"
          git push origin main
